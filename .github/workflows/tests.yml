name: Tests

on:
    push:
    pull_request:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    lint:
        name: Lint & Format
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.5"
                  coverage: none

            - name: Cache Composer dependencies
              uses: actions/cache@v5
              with:
                  path: vendor
                  key: composer-${{ hashFiles('**/composer.lock') }}
                  restore-keys: composer-

            - name: Install dependencies
              run: composer install --prefer-dist --no-interaction

            - name: Run Pint
              run: ./vendor/bin/pint --test

            - name: Run Larastan
              run: ./vendor/bin/phpstan analyse

    test:
        name: Test PHP ${{ matrix.php }} with Laravel ${{ matrix.laravel }}
        runs-on: ubuntu-latest
        needs: lint
        strategy:
            fail-fast: false
            matrix:
                php: ["8.3", "8.4", "8.5"]
                laravel: ["11.*", "12.*"]

        steps:
            - uses: actions/checkout@v6

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: ${{ matrix.php }}
                  extensions: dom, curl, libxml, mbstring, zip
                  coverage: xdebug

            - name: Cache Composer dependencies
              uses: actions/cache@v5
              with:
                  path: vendor
                  key: composer-php${{ matrix.php }}-laravel${{ matrix.laravel }}-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      composer-php${{ matrix.php }}-laravel${{ matrix.laravel }}-
                      composer-php${{ matrix.php }}-
                      composer-

            - name: Install dependencies
              run: |
                  composer require illuminate/support:${{ matrix.laravel }} \
                    illuminate/contracts:${{ matrix.laravel }} \
                    --prefer-dist --no-interaction --no-update
                  composer update --prefer-dist --no-interaction

            - name: Run tests
              run: ./vendor/bin/pest
